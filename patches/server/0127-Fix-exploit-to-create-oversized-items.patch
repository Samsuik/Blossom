From 4f6a7a499ec68cd908d1d587e1769ff1e015a5f3 Mon Sep 17 00:00:00 2001
From: Samsuik <kfian294ma4@gmail.com>
Date: Sat, 19 Jul 2025 18:45:25 +0100
Subject: [PATCH] Fix exploit to create oversized items

This fixes players being able to stack items above their maximum stack
size using beacons, enchantment tables and brewing stands.

diff --git a/src/main/java/net/minecraft/server/Container.java b/src/main/java/net/minecraft/server/Container.java
index 05e60dce6..3511ebb76 100644
--- a/src/main/java/net/minecraft/server/Container.java
+++ b/src/main/java/net/minecraft/server/Container.java
@@ -323,6 +323,12 @@ public abstract class Container {
                                         k1 = itemstack4.getMaxStackSize() - itemstack1.count;
                                     }
 
+                                    // Blossom start - fix creating oversized items
+                                    if (k1 < 0) {
+                                        k1 = 0;
+                                    }
+                                    // Blossom end - fix creating oversized items
+
                                     itemstack4.cloneAndSubtract(k1);
                                     if (itemstack4.count == 0) {
                                         playerinventory.setCarried((ItemStack) null);
@@ -397,8 +403,19 @@ public abstract class Container {
                             slot2.a(entityhuman, itemstack3);
                         }
                     } else if (!slot2.hasItem() && itemstack1 != null && slot2.isAllowed(itemstack1)) {
-                        playerinventory.setItem(j, (ItemStack) null);
-                        slot2.set(itemstack1);
+                        // Blossom start - fix creating oversized items
+                        int itemsToMove = Math.min(itemstack1.count, slot2.getMaxStackSize(itemstack1));
+                        ItemStack newItemStack = itemstack1.cloneAndSubtract(itemsToMove);
+                        if (itemstack1.count <= 0) {
+                            playerinventory.setItem(j, null);
+                        } else {
+                            ((EntityPlayer) entityhuman).playerConnection.sendPacket(new PacketPlayOutSetSlot(0, j + 36, itemstack1));
+                        }
+                        if (newItemStack.count > 0) {
+                            slot2.set(newItemStack);
+                        }
+                        ((EntityPlayer) entityhuman).playerConnection.sendPacket(new PacketPlayOutSetSlot(this.windowId, i, newItemStack));
+                        // Blossom end - fix creating oversized items
                     }
                 }
             } else if (k == 3 && entityhuman.abilities.canInstantlyBuild && playerinventory.getCarried() == null && i >= 0) {
-- 
2.50.1

